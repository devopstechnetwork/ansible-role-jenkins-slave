---
- name: Install requirements
  apt:
    name: "{{ requirements }}"
    update_cache: yes
    state: present
  retries: 3
  delay: 2
  register: result
  until: result is success
  become: true
  when: requirements | default([]) | length > 0

- name: Create jenkins user
  user:
    name: "{{ jenkins_slave_linux_jenkins_username }}"
    password: >-
      {{ jenkins_slave_linux_jenkins_password
          | password_hash('sha512', 65535 | random(seed=inventory_hostname)
          | string) }}
    update_password: always
    state: present
    createhome: true
    shell: /bin/bash
  become: true

- name: Create jenkins slave home directory
  file:
    path: "{{ jenkins_slave_linux_home }}"
    state: directory
    owner: "{{ jenkins_slave_linux_jenkins_username }}"
    group: "{{ jenkins_slave_linux_jenkins_username }}"
    mode: "0755"
  become: true
  when: jenkins_slave_linux_home | trim

- name: Download agent.jar from jenkins master
  get_url:
    url: "{{ jenkins_master_url }}/jnlpJars/agent.jar"
    dest: "{{ jenkins_slave_linux_home }}/agent.jar"
    owner: "{{ jenkins_slave_linux_jenkins_username }}"
    group: "{{ jenkins_slave_linux_jenkins_username }}"
  become: true
  when: jenkins_slave_linux_home | trim

- name: Get the secret jenkins slave
  uri:
    url: "{{ jenkins_master_url }}/computer/{{ jenkins_slave_linux_agent_name }}/slave-agent.jnlp"
    method: GET
    force_basic_auth: true
    user: "{{ jenkins_master_username }}"
    password: "{{ jenkins_master_password }}"
    return_content: true
  register: jenkins_slave_jnlp_file

- name: Extract Slave secret from http response
  set_fact:
    jenkins_slave_agent_secret: "{{ jenkins_slave_jnlp_file.content | regex_search('([a-z0-9]*)(?=</argument>)') }}"

- debug: msg="{{ jenkins_slave_agent_secret }}"
